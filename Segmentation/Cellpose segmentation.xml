<IAPipeline Description="Image Analyst MKII XML 1.0" Version="1171"><Pipeline Version="1171"><Functions><fSetScaling Caption="Set scaling/LUT" ID="0" PID="3" Description="Set scaling/LUT"><Caption>Set scaling/LUT</Caption><Position Top="137" Left="28" Height="25" Width="95"/><Parameters><lut ID="0" Type="Text" Value="Grayscale"/><type ID="1" Type="Text" Value="Percentile by frame"/><pmin ID="2" Type="Real" Value="10" SValue=""/><pmax ID="3" Type="Real" Value="99" SValue=""/><fmin ID="4" Type="Real" Value="0" SValue=""/><fmax ID="5" Type="Real" Value="0" SValue=""/><gamma ID="6" Type="Real" Value="1" SValue=""/><color ID="7" Type="Text" Value=""/></Parameters><Inputs Types="P" IDs="5"/><Outputs Types="CP" IDs="2;7"/></fSetScaling><fInput Caption="Input image" ID="1" PID="0" Description="Input image"><Caption>Input image</Caption><Position Top="0" Left="6" Height="25" Width="74"/><Parameters><image ID="0" Type="Text" Value="[Actual window]"/></Parameters><Inputs Types="" IDs=""/><Outputs Types="C" IDs="6"/></fInput><fRunEXE Caption="Run EXE" ID="2" PID="162" Description="Run EXE"><Caption>Run EXE</Caption><Position Top="178" Left="40" Height="25" Width="61"/><Parameters><filename ID="0" Type="Text" Value="=&quot;&quot;%PythonFolder%\Scripts\activate.bat&quot; cellpose2 &amp;&amp; &quot;python.exe&quot;&quot;"/><arguments ID="1" Type="Text" Value="-m --dir --pretrained_model --diameter --cellprob_threshold --flow_threshold --chan --chan2 --batch_size --save_tif --verbose --use_gpu --no_npy "/><format ID="2" Type="Text" Value="TIFPadded"/><way ID="3" Type="Text" Value="RGB as input#_frame#.ext"/><exportsuffix ID="4" Type="Text" Value=""/><results ID="5" Type="Text" Value="1_*_cp_masks.tif"/><resultformat ID="6" Type="Text" Value="TIFF (*.tif)"/><customtemp ID="7" Type="Text" Value=""/><deletetemp ID="8" Type="Bool" Value="Yes"/><forceclose ID="9" Type="Bool" Value="No"/><nowait ID="10" Type="Bool" Value="No"/><loopframes ID="11" Type="Bool" Value="No"/><parallel ID="12" Type="Integer" Value="1" SValue=""/><args1 ID="13" Type="Text" Value="cellpose"/><args2 ID="14" Type="Text" Value="=%temp%"/><args3 ID="15" Type="Text" Value="cyto"/><args4 ID="16" Type="Text" Value="0"/><args5 ID="17" Type="Text" Value="0.5"/><args6 ID="18" Type="Text" Value="0.5"/><args7 ID="19" Type="Text" Value="0"/><args8 ID="20" Type="Text" Value="0"/><args9 ID="21" Type="Text" Value="8"/><args10 ID="22" Type="Text" Value=""/></Parameters><Inputs Types="P" IDs="0"/><Outputs Types="P" IDs="3"/></fRunEXE><fSetSegmentationClassifiers Caption="Set Segmentation Classifiers" ID="3" PID="48" Description="Set Segmentation Classifiers"><Caption>Set Segmentation Classifiers</Caption><Position Top="223" Left="0" Height="25" Width="161"/><Parameters><type ID="0" Type="Text" Value="Min"/><volume ID="1" Type="Integer" Value="0" SValue=""/><surface ID="2" Type="Integer" Value="0" SValue=""/><maxarea ID="3" Type="Integer" Value="0" SValue=""/><maxperimeter ID="4" Type="Integer" Value="0" SValue=""/><maxdiameter ID="5" Type="Real" Value="0" SValue=""/><shapefactor ID="6" Type="Real" Value="0" SValue=""/><sphericalshapefactor ID="7" Type="Real" Value="0" SValue=""/><totalfileamentlength ID="8" Type="Integer" Value="0" SValue=""/><totalbranchpoints ID="9" Type="Integer" Value="0" SValue=""/><fiberlength ID="10" Type="Real" Value="0" SValue=""/><fiberbreadth ID="11" Type="Real" Value="0" SValue=""/><nearestneighbor ID="12" Type="Real" Value="0" SValue=""/><numberofneighbors ID="13" Type="Integer" Value="0" SValue=""/><distancetoedge ID="14" Type="Real" Value="0" SValue=""/></Parameters><Inputs Types="P" IDs="2"/><Outputs Types="P" IDs="8"/></fSetSegmentationClassifiers><fReEvSegment Caption="Reevaluate Segments" ID="4" PID="101" Description="Reevaluate Segments"><Caption>Reevaluate Segments</Caption><Position Top="285" Left="21" Height="25" Width="127"/><Parameters><reapply ID="0" Type="Bool" Value="Yes"/><textoutput ID="1" Type="Bool" Value="No"/><weld ID="2" Type="Bool" Value="No"/><noedges ID="3" Type="Bool" Value="No"/></Parameters><Inputs Types="P" IDs="8"/><Outputs Types="" IDs=""/></fReEvSegment><fWienerFilterSmooth Caption="Wiener Filter Smooth" ID="5" PID="84" Description="Wiener Filter Smooth"><Caption>Wiener Filter Smooth</Caption><Position Top="81" Left="1" Height="25" Width="122"/><Parameters><width ID="0" Type="Integer" Value="5" SValue=""/><noise ID="1" Type="Real" Value="0.5" SValue=""/></Parameters><Inputs Types="P" IDs="6"/><Outputs Types="P" IDs="0"/></fWienerFilterSmooth><fCopy Caption="Copy" ID="6" PID="4" Description="Copy"><Caption>Copy</Caption><Position Top="45" Left="45" Height="25" Width="42"/><Parameters><linked ID="0" Type="Bool" Value="Yes"/></Parameters><Inputs Types="P" IDs="1"/><Outputs Types="P" IDs="5"/></fCopy><fClose Caption="Close" ID="7" PID="22" Description="Close"><Caption>Close</Caption><Position Top="181" Left="158" Height="25" Width="45"/><Parameters><target ID="0" Type="Text" Value="Image"/></Parameters><Inputs Types="P" IDs="0"/><Outputs Types="" IDs=""/></fClose><fSetSegmentationClassifiers Caption="Set Segmentation Classifiers" ID="8" PID="48" Description="Set Segmentation Classifiers"><Caption>Set Segmentation Classifiers</Caption><Position Top="251" Left="1" Height="25" Width="161"/><Parameters><type ID="0" Type="Text" Value="Max"/><volume ID="1" Type="Integer" Value="0" SValue=""/><surface ID="2" Type="Integer" Value="0" SValue=""/><maxarea ID="3" Type="Integer" Value="0" SValue=""/><maxperimeter ID="4" Type="Integer" Value="0" SValue=""/><maxdiameter ID="5" Type="Real" Value="0" SValue=""/><shapefactor ID="6" Type="Real" Value="0" SValue=""/><sphericalshapefactor ID="7" Type="Real" Value="0" SValue=""/><totalfileamentlength ID="8" Type="Integer" Value="0" SValue=""/><totalbranchpoints ID="9" Type="Integer" Value="0" SValue=""/><fiberlength ID="10" Type="Real" Value="0" SValue=""/><fiberbreadth ID="11" Type="Real" Value="0" SValue=""/><nearestneighbor ID="12" Type="Real" Value="0" SValue=""/><numberofneighbors ID="13" Type="Integer" Value="0" SValue=""/><distancetoedge ID="14" Type="Real" Value="0" SValue=""/></Parameters><Inputs Types="P" IDs="3"/><Outputs Types="P" IDs="4"/></fSetSegmentationClassifiers></Functions></Pipeline><Parameters Version="1171"><Caption>Cellpose segmentation</Caption><DesignVersion>1</DesignVersion><Description>This snippet uses Cellpose to detect nuclei or cells in a single channel. The input image (series) is exported, processed by Cellpose 2.0 command line and results are imported. Image transfer is through a unique temp folder opened for each call, within the Image Export Folder. See Files/Set Folder Locations to set this. By default, these temporary folders are deleted, see switch in the Run EXE function. Use Cellpose GUI to fine tune thresholds. Start GUI in Pipelines/Using External Programs/Cellpose/Launch cellpose GUI. Save images to be loaded into the GUI use the Files/Export RGB Full Size Image, or by disabling temp folder deletion above, and locating the temp folder.

Cellpose will run faster if the same number of images are processed as an image series than one-by-one. Further speed increment can be achieved by increasing batch size and number of parallel processes, depending on the available system memory and the image size. Use batch size of 64 and 4 parallel processes with 24GB GPU. Further command line options can be entered by editing this pipeline in the Run EXE function, Argument parameter. 

This pipeline uses Cellpose 2.0. Cellpose is installed by the user as given in the Image Analyst MKII Primer/TOC/Using external programs.

Pachitariu M, Stringer C. Cellpose 2.0: how to train your own model. Nat Methods. 2022;19(12):1634-41
https://github.com/MouseLand/cellpose

Keywords: U-Net, CNN, deep learning, generalist cell segmentation, artificial intelligence, AI

</Description><Parameters><param ID="0" UID="60840312" Caption="Cells: Scale maximum (percentile)" Type="Real" Value="99" Constraints="-1-100" ErrorMessage="Maximal percentile must be between 0 and 100 and must be larger than minimal percentile. Alternatively, -1 overrides percentile with fixed value set below." Hint="This percentile of the image histogram sets the intensity value where the maximum of the Look Up Table (LUT) is scaled. Use -1 to override this with fixed value set below at &quot;Max value&quot;."><link Caption="Set scaling/LUT::Max percentile (1)" ID="0" paramID="3" paramName="pmax"/></param><param ID="1" UID="64381686" Caption="Cells: Smooth factor" Type="Real" Value="0.5" Constraints="0-1" ErrorMessage="" Hint="Wiener filter noise level (0-1). Higher value provides more smoothing."><link Caption="Wiener Filter Smooth::Noise level" ID="5" paramID="1" paramName="noise"/></param><param ID="2" UID="64381756" Caption="Cells: Gamma" Type="Real" Value="1" Constraints="&gt;0" ErrorMessage="Gamma value" Hint="A gamma value &gt;1 makes image supralinearly brighter, a gamma value &lt;1 makes the image sublinearly darker."><link Caption="Set scaling/LUT::Gamma" ID="0" paramID="6" paramName="gamma"/></param><param ID="3" UID="69614917" Caption="Cells: Cellpose Model (pretrained network)" Type="Text" Value="cyto" Constraints="" ErrorMessage="" Hint="Enter a pretrained model name from the model zoo, or name for user trained model installed into the GUI. See --pretrained_model option in Cellpose."><link Caption="Run EXE::Argument 3 (--pretrained_model)" ID="2" paramID="15" paramName="args3"/></param><param ID="4" UID="69614921" Caption="Cells: Cellpose Diamenter (pixels)" Type="Text" Value="0" Constraints="" ErrorMessage="" Hint="Approximate diameter of objects in pixels"><link Caption="Run EXE::Argument 4 (--diameter)" ID="2" paramID="16" paramName="args4"/></param><param ID="5" UID="69615522" Caption="Cells: Cellpose --flow_threshold" Type="Text" Value="0.5" Constraints="" ErrorMessage="" Hint="Maximum allowed error of the flows for each mask."><link Caption="Run EXE::Argument 6 (--flow_threshold)" ID="2" paramID="18" paramName="args6"/></param><param ID="6" UID="69615520" Caption="Cells: Cellpose --cellprob_threshold" Type="Text" Value="0.5" Constraints="" ErrorMessage="" Hint="Minimum probability to return ROIs"><link Caption="Run EXE::Argument 5 (--cellprob_threshold)" ID="2" paramID="17" paramName="args5"/></param><param ID="7" UID="60840193" Caption="Cells: Minimum size of cells (pixels area)" Type="Integer" Value="0" Constraints="&gt;0" ErrorMessage="Volume must be &gt;0 or 0 for not checking." Hint="The result provided by Cellpose is gated for this minimum pixel area per nucleus"><link Caption="Set Segmentation Classifiers::Volume" ID="3" paramID="1" paramName="volume"/></param><param ID="8" UID="64381674" Caption="Cells: Maximum size of cells (pixels area)" Type="Integer" Value="0" Constraints="&gt;0" ErrorMessage="Volume must be &gt;0 or 0 for not checking." Hint="Volume in 3D, area in 2D. 0 for not checking"><link Caption="Set Segmentation Classifiers::Volume" ID="8" paramID="1" paramName="volume"/></param><param ID="9" UID="51291673" Caption="Python.exe in the Cellpose Environment" Type="Text" Value="=&quot;&quot;%PythonFolder%\Scripts\activate.bat&quot; cellpose &amp;&amp; &quot;python.exe&quot;&quot;" Constraints="" ErrorMessage="" Hint="Prerequisite:Cellpose. Change environment name if needed. Syntax: Filename with full path, or filename only if it is in the environment path. Alternatively, use one or more command prompt expressions with arguments concatenated by &amp;&amp; and the whole expression quoted with &quot;."><link Caption="Run EXE::Path and filename (*.exe) (1)" ID="2" paramID="0" paramName="filename"/></param><param ID="10" UID="69615719" Caption="Cellpose: number of parallel processes" Type="Integer" Value="1" Constraints="&gt;1" ErrorMessage="The number of parallel processes must be greater than zero." Hint="Image series and time courses will be split into multiple parts and separate instances of the external program is launched."><link Caption="Run EXE::Number of parallel processes (1)" ID="2" paramID="12" paramName="parallel"/></param><param ID="11" UID="69615714" Caption="Cellpose: --batch_size" Type="Text" Value="8" Constraints="" ErrorMessage="" Hint="Set batch size according to the GPU memory"><link Caption="Run EXE::Argument 9 (--batch_size) (1)" ID="2" paramID="21" paramName="args9"/></param></Parameters></Parameters><Options Version="1171"><usesexcel Value="false"/><warnrefimage Value="false"/><warnrefimagemsg Value=""/><matrixsavedef Value="false"/></Options></IAPipeline>
